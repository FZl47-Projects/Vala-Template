<!DOCTYPE html>
<html lang="fa" dir="rtl">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>فرم لیزر</title>
        <!-- BOOTSTRAP -->
        <link rel="stylesheet" href="../assets/vendors/bootstrap.min.css" />
        <!-- SWIPER -->
        <link rel="stylesheet" href="../assets/vendors/swiper.css" />

        <!-- MAIN CSS -->
        <link rel="stylesheet" href="../assets/styles/cartex.css" />

        <!-- AXIOS PACKAGE -->
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <!-- ALERT -->

        <!-- Custom -->
        <style>
          

            #user-info{
                margin: 10px auto;
            }

            #user-info span{
                display: inline-block;
                width: 85px;
            }

            #user-info p{
                display: inline-block;
                margin-right: 5px;
            }

            button{
                width: 60px;
                margin: 3px;
                padding: 5px 10px;
                border-radius: 10px;
                border: none;
                outline: none;
            }

            .btn-none{
                background: transparent;
                color: #fff;
                border: 1px solid #666;
            }

            .btn-submit{
                background: rgb(7, 202, 82);
                color: #fff;
            }

            .btn-delete{
                background: rgb(255, 43, 28);
                color: #fff;
            }

            .btn-edit{
                background: rgb(6, 145, 209);
                color: #fff;
            }

            .btn-disabled{
                cursor: not-allowed!important;
                opacity: .4!important;
            }

            .select-btn{
                margin: 3px;
                width: 60%;
                max-width: 80px;
                color: #111;
            }

            .title{
                font-size: 180%;
            }

            .text-left{
                text-align: left;
            }

            #select-district-modal{
                margin: 20px auto;
                max-width: 400px;
                height: 400px;
                border: 1px solid #ffefce;
                background: #222;
                color: #fff;
                padding: 10px;
                border-radius: 15px;
            }

            #selected-districts-modal{
                margin: 20px auto;
                max-width: 400px;
                height: 400px;
                border: 1px solid #ffefce;
                background: #222;
                color: #fff;
                padding: 10px;
                border-radius: 15px;
            }

            #select-operator-modal{
                margin: 20px auto;
                max-width: 400px;
                height: 400px;
                border-radius: 15px;
                border: 1px solid #ffefce;
                background: #222;
                color: #fff;
                padding: 20px 10px;
            }

            .district{
                padding: 10px;
            }

            .district p{
                margin: 0;
            }
            
            input , select{
                width: 90%;
                margin: auto!important;
                display: block;
                border: 1px solid #fff;
                border-radius: 8px;
                padding: 7px 10px;
                color: #fff;
                background: inherit;
            }

            option{
                font-size: 150%;
                background: #222;
            }

            option:checked{
                color: #ff9924;
            }

    
            .modal{
                font-size: 120%;
            }

            .district-selected{
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: 1px solid #ffe1bfa8;
                border-radius: 10px;
                padding: 8px;
                margin: 9px 2px;
            }

            .ltr{
                direction: ltr;
            }
         
           

        </style>
    <link
    rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"/>
    </head>
    <body style="background-color: rgb(37, 37, 35);">
        <div class="container-fluid bg">
            <main class="main" style="padding-bottom: 130px;">
                <div class="hh">
                    <div class="col-8 col-md-3 bb">
                        <span><img
                                src="../assets/images/icon-valla/chat-right.png"
                                alt=""></span>
                        <span>فرم لیزر</span>
                    </div>
                    <div class="col-12 cc">
                        <div class="content-Definition-of-diet">
                            <div class="up-page">
                                
                            <!-- <a href="../Operator/user.html" class="add-user">افزودن کاربر</a> -->
                            <div id="user-info">
                                <div>
                                    <span>نام و نام خانوادگی : </span>
                                    <p id="user-info-name">-</p>
                                </div>
                                <div>
                                    <span>کد ملی : </span>
                                    <p id="user-info-nationalcode">-</p>
                                </div>
                                <div>
                                    <span>شماره همراه : </span>
                                    <p id="user-info-phonenumber">-</p>
                                </div>
                            </div>
                            <section class="content-Definition-inner ">
                                <div class="content-table">
                                    <div class="content-title-row " id="container-cortexes">
                                        <div class="title-row">
                                            <div class="title-item col-2">تاریخ</div>
                                            <div class="title-item col-5">ناحیه و شدت</div>
                                            <div class="title-item col-3">اپراتور</div>
                                            <div class="title-item col-2">عملیات ها</div>
                                        </div>
                                        <!-- get from API -->
                                        <!-- ... -->
                                    </div>
                                    <div class="btn-add-row " id="btn-add-meet">اضافه کردن جلسه</div>
                                   
                                </div>
                            </section>                           
                        </div>
                    </div>
                    
                </div>
            </main>
        </div>

        <div id="select-district-modal" class="modal fade">
            
            <div class="modal-header">
                <div class="title">
                    <p>انتخاب ناحیه و شدت</p>
                </div>
              </div>
            <div class="districts">
                <div class="district">
                    
                    <div>
                        <p>ناحیه ها :</p>
                        <select id="select-district">
                            <option value="0" selected>انتخاب نشده است</option>
                            <!-- get from API -->
                            <!-- ... -->
                        </select>
                    </div>
                    <div>
                        <p>شدت :</p>
                        <input type="number" id="inp-intensity-district" placeholder="شدت مورد نظر ">
                    </div>
                    <div class="text-left mt-3 p-1">
                        <button class="btn-none" data-dismiss="modal">لغو</button>
                        &nbsp;
                        <button id="submit-select-district" class="btn-submit">
                            ثبت
                        </button>
                    </div>
                </div>
            </div> 
        </div>

        <div id="selected-districts-modal" class="modal fade">
            
            <div class="modal-header">
                <div class="title">
                    <p>ناحیه ها و شدت های انتخاب شده</p>
                </div>
              </div>
            <div class="districts">
                    <div class="selected-districts">
                        <!-- get from JS(script) -->

                    </div>
                    <div class="text-left mt-3 p-1">
                        <button class="btn-none" data-dismiss="modal">بستن</button>
                    </div>
            </div> 
        </div>

        <div id="select-operator-modal" class="modal fade">
            <div class="modal-header mb-5">
                <div class="title">
                    <p>انتخاب اپراتور</p>
                </div>
            </div>
            <div>
                <p>اپراتور ها:</p>
                <select id="select-operator">
                    <option value="0" selected>انتخاب نشده است</option>
                    <!-- get from API -->
                    <!-- ... -->
                </select>
                <div class="text-left mt-5 col-11 m-auto">
                    <button class="btn-none" data-dismiss="modal">لغو</button>
                </div>
            </div>
        </div>
        

        <!-- ALERT -->
    <script
    type="text/javascript"
    src="https://cdn.jsdelivr.net/npm/toastify-js"
  ></script>
 

         <!-- BASE CSS -->
        <link rel="stylesheet" href="../assets/styles/base.css">

        <!-- Notify -->
        <link rel="stylesheet" href="../assets/styles/notify.css">
        <script src="../assets/js/notify.js"></script>

        <!-- JQ -->
        <script src="../assets/js/jquery_3.7.0.min.js"></script>

         <!-- BASE JS -->
         <script src="../assets/js/base.js"></script>

        <!-- BASE API -->
        <script src="../assets/js/api/base.js"></script>


        <!-- For Modal -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    

        <script>

            let cortext_id_selected_for_districts = null
            let cortext_id_selected_for_operator = null

            let container_cortexes = document.querySelector('#container-cortexes')
            let btn_add_meet = document.querySelector('#btn-add-meet')
            let select_district_modal = document.querySelector('#select-district-modal')
            let selected_districts_modal = document.querySelector('#selected-districts-modal')
            let select_operator_modal = document.querySelector('#select-operator-modal')
            
            let btn_submit_select_district = document.querySelector('#submit-select-district')
            let inp_select_operator = document.querySelector('#select-operator')
            

            // Init
            let _user_id = getUrlParameter('user-id')
            if (!_user_id){
                // user-id not found in query search url
                // then redirect to index operator
                redirect(OPERATOR_INDEX_URL)
            }
            getUserInfo(_user_id)

            getDistricts()
            getOperators()

            const _data_meet = {}

            
            // Events
            btn_add_meet.addEventListener('click',function(){
                addCortex()
            })

            btn_submit_select_district.addEventListener('click',function(){
                let inp_select_district = document.querySelector('#select-district')
                let inp_intensity_district = document.querySelector('#inp-intensity-district')

                let select_val = inp_select_district.value
                let intensity_val = inp_intensity_district.value

                let select_val_is_valid = true
                let intensity_val_is_valid = true

                if (select_val == '0'){
                    select_val_is_valid = false
                    createNotify({
                        'title':'ارور',
                        'message':'لطفا ناحیه را انتخاب کنید',
                        'theme':'error'
                    })
                }
                if (!intensity_val){
                    intensity_val_is_valid = false
                    createNotify({
                        'title':'ارور',
                        'message':'لطفا فیلد شدت را به درستی پر نمایید',
                        'theme':'error'
                    })
                }

                if (intensity_val_is_valid && select_val_is_valid){
                    if (cortext_id_selected_for_districts == null){
                        createNotify({
                            'title':'ارور',
                            'message':'مشکلی پیش امده است',
                            'theme':'error'
                        })
                    }else{
                        let is_duplicate = false
                        _data_meet[cortext_id_selected_for_districts]['is_new'] = true
                        let cortexes = _data_meet[cortext_id_selected_for_districts]['cortexes']
                        for (let cortex of cortexes){
                            if(cortex.id == select_val){
                                is_duplicate = true
                            }
                        }
                        if (is_duplicate == false){
                            cortexes.push({
                                'id':select_val,
                                'district_name':inp_select_district.options[inp_select_district.selectedIndex].text,
                                'intensity_value':intensity_val
                            })

                        }
                        toggleModalSelectDistricts(false)
                        stateBtnSubmitCortex(cortext_id_selected_for_operator)
                        cortext_id_selected_for_districts = null
                    }
                    
                }

            })
            
            inp_select_operator.addEventListener('change',function(){
                _data_meet[cortext_id_selected_for_operator]['operator'] = inp_select_operator.value
                toggleModalSelectOperator(false)
                stateBtnSubmitCortex(cortext_id_selected_for_operator)
            })


            function setEventsSelectedDistrict(cortex){
                let districts_selected = document.querySelectorAll('.district-selected')
                for (let district of districts_selected){

                    // delete btn
                    try{
                        district.querySelector('.btn-delete-selected-district').addEventListener('click',function(){
                        district.remove()
                        let cortex_id = cortex.getAttribute('data-id')
                        let districts = _data_meet[cortex_id]['cortexes']
                        let district_id = district.getAttribute('data-district-id')
                        let index_district = districts.findIndex(({ district_id }) => district_id == district_id);
                        // remove from list 
                        districts.splice(index_district, 1);
                        _data_meet[cortex_id]['cortexes'] = districts
                        stateBtnSubmitCortex(cortex_id)
                        callApi(BASE_API_URL + 'cortex/' + cortex_id + '/district/' + district_id,{
                            method:'delete',
                            response:function(data){
                                // silent
                            },
                            error:function(errors){
                                // silent
                            }
                        })
                    })
                    }catch(e){}

                }
            }

            // Actions
            function getUserInfo(user_id){
                callApi(BASE_API_URL + 'cortex/user/' + _user_id,{
                    loading_el: document.querySelector('.up-page'),
                    loading_size:'normal',
                    method: 'get',
                    response:function(data){
                        setUserInfo(data.user)
                        setUserCortex(data.cortexes)
                        if (data.cortexes.length == 0){
                            createNotFound(container_cortexes)
                        }else{
                            removeNotFound(container_cortexes)
                        }
                    }
                })
            }

            function getDistricts(){
                callApi(BASE_API_URL + 'cortex/district',{
                    loading_el:select_district_modal,
                    method:'get',
                    response:function(data){
                        setSelectDistricts(data)
                    }
                })
            }

            function getOperators(){
                callApi(BASE_API_URL + 'cortex/operator',{
                    loading_el:select_operator_modal,
                    method:'get',
                    response:function(data){
                        setSelectOperators(data)
                    }
                })
            }
            

            function setUserInfo(user){
                document.querySelector('#user-info-name').innerHTML = user.name
                document.querySelector('#user-info-nationalcode').innerHTML = user.nationalcode
                document.querySelector('#user-info-phonenumber').innerHTML = user.phone_number
            }

            function setUserCortex(cortexes){
                for (let cortex of cortexes){
                    addCortex(cortex)
                }
            }
            
            function setSelectDistricts(districts){
                let select_districts = document.querySelector('#select-district')
                for(let district of districts){
                    select_districts.innerHTML += getElementOptionSelectDistrict(district)
                }
            }

            function setSelectOperators(operators){
                let select_operator = document.querySelector('#select-operator')
                for(let operator of operators){
                    select_operator.innerHTML += getElementOptionSelectOperator(operator)
                }
            }

            function addCortex(data=null){
                removeNotFound(container_cortexes)
                let cortex = document.createElement('div')
                cortex.classList.add('cortex-base')
                if (data == null){
                    // New cortex
                    cortex.classList.add('cortex-new')
                    let cortex_id = randomString()
                    _data_meet[cortex_id] = {
                        'cortexes':[],
                        'operator':null,
                        'is_new':true
                    }
                    cortex.setAttribute('data-id',cortex_id)
                    cortex.setAttribute('data-type','new')
                    cortex.innerHTML = getEmptyElementCortex()
                }else{
                    cortex.classList.add('cortex')
                    _data_meet[data.id] = {
                        'cortexes':data.districts, 
                        'operator':data.operator.id,
                        'is_new':false
                    }
                    cortex.setAttribute('data-id',data.id)
                    cortex.setAttribute('data-type','submited')
                    cortex.innerHTML = getElementCortex(data)
                }
                container_cortexes.appendChild(cortex)

                init_action_buttons_cortexes()
            }

            function init_action_buttons_cortexes(){
                let cortexes = document.querySelectorAll('.cortex-base')
                for(let cortex of cortexes){
                    
                    try{
                        // submit btn
                        cortex.querySelector('.btn-submit').addEventListener('click',function(){
                        let allow_to_click = this.getAttribute('allow-to-click')
                        if (allow_to_click == 'true'){
                            let data_id = cortex.getAttribute('data-id')
                            let cortex_obj = _data_meet[data_id]
                            cortex_obj['user_id'] = _user_id
                            callApi(BASE_API_URL + 'cortex/',{
                                loading_el:cortex,
                                data:cortex_obj,
                                response:function(data){
                                    cortex.remove()
                                    addCortex(data)
                                    try{
                                        this.setAttribute('allow-to-click',false)
                                        this.classList.add('btn-disabled')
                                    }catch(e){}
                                }
                            })
                        }
                    })
                    }catch(e){}

                    // delete btn
                    cortex.querySelector('.btn-delete').addEventListener('click',function(){
                        let data_id = cortex.getAttribute('data-id')
                        
                        callApi(BASE_API_URL + 'cortex/' + data_id,{
                            loading_el:cortex,
                            method:'delete',
                            response:function(data){
                                delete _data_meet[data_id]
                                cortex.remove()
                            },error:function(errors){
                                delete _data_meet[data_id]
                                cortex.remove()
                            }
                        })
                    })

                    
                    try{
                        // select districts btn
                        cortex.querySelector('.select-districts').addEventListener('click',function(){
                            toggleModalSelectDistricts(true)
                            cortext_id_selected_for_districts = cortex.getAttribute('data-id')

                        })
                    }catch(e){}


                    // get|selected districts btn
                    cortex.querySelector('.selected-districts').addEventListener('click',function(){
                        let cortex_el = cortex
                        toggleModalSelectedDistricts(true)
                        cortext_id_selected_for_districts = cortex.getAttribute('data-id')
                        let container_selected_districts = selected_districts_modal.querySelector('.selected-districts')
                        let cortexes = _data_meet[cortext_id_selected_for_districts]['cortexes']
                        container_selected_districts.innerHTML = '' // clear
                        for (let cortex of cortexes){
                            container_selected_districts.innerHTML += getElementSelectedDistrict(cortex,_data_meet[cortext_id_selected_for_districts]['is_new'])
                            setEventsSelectedDistrict(cortex_el)
                        }
                        if (cortexes.length == 0){
                            createNotFound(container_selected_districts)
                        }else{
                            removeNotFound(container_selected_districts)
                        }
                    })

                    // select operators btn
                    try{
                        cortex.querySelector('.select-operator').addEventListener('click',function(){
                        toggleModalSelectOperator(true)
                        let cortex_id = cortex.getAttribute('data-id')
                        cortext_id_selected_for_operator = cortex.getAttribute('data-id')
                        let selected_operator = _data_meet[cortex_id]['operator']
                        let select_operator_el = document.querySelector('#select-operator')
                        if (selected_operator){
                            select_operator_el.value = selected_operator
                        }else{
                            select_operator_el.value = 0
                        }
                        })
                    }catch(e){}

                }
            }

            function toggleModalSelectDistricts(state){
                state = state == true ? 'show' : 'hide'
                $(select_district_modal).modal(state)
            }

            function toggleModalSelectedDistricts(state){
                state = state == true ? 'show' : 'hide'
                $(selected_districts_modal).modal(state)
            }

            function toggleModalSelectOperator(state){
                state = state == true ? 'show' : 'hide'
                $(select_operator_modal).modal(state)
            }

            function stateBtnSubmitCortex(cortex_id){
                let cortex_obj = _data_meet[cortex_id]
                let cortex_el = document.querySelector(`[data-id="${cortex_id}"]`)
                let btn_submit = cortex_el.querySelector('.btn-submit')
                if (cortex_obj.operator && cortex_obj.operator.id != 0 && cortex_obj.cortexes.length > 0){
                    btn_submit.classList.remove('btn-disabled')
                    btn_submit.setAttribute('allow-to-click',true)
                }else{
                    btn_submit.classList.add('btn-disabled')
                    btn_submit.setAttribute('allow-to-click',false)
                }
            }


            function selectItemByValue(elmnt, value){
                for(var i=0; i < elmnt.options.length; i++){
                    if(elmnt.options[i].value === value) {
                        elmnt.selectedIndex = i;
                        break;
                    }
                }
            }



            // Elements

            function getElementSelectedDistrict(data,is_new){
                return `
                    <div class="district-selected" data-district-id="${data.id}" is-new="${is_new}">
                        <div>${data.district_name}</div>
                        <div>${data.intensity_value}</div>
                        ${is_new ? 
                            `<div>
                                <button class="btn-delete btn-delete-selected-district">
                                    حذف    
                                </button>    
                            </div>` : ''}
                    </div>
                `
            }

            function getEmptyElementCortex(){
                return `
                    <div class="table-row text-center">
                        <div class="col-2">-</div>
                        <div class="col-5">
                            <button class="select-btn select-districts">انتخاب</button>
                            <button class="select-btn btn-primary selected-districts">مشاهده</button>
                        </div>
                        <div class="col-3">
                            <button changed="false" class="select-btn select-operator">انتخاب</button>
                        </div>
                        <div class="col-2">
                            <button class="btn-submit btn-disabled" allow-to-click="false">
                                ثبت    
                            </button>
                            <button class="btn-delete">
                                حذف    
                            </button>
                        <div>
                    </div>
                `
            }

            function getElementCortex(data){
                return `
                    <div class="table-row text-center">
                        <div class="col-2 ltr">${data.created}</div>
                        <div class="col-5">
                            <button class="select-btn btn-primary selected-districts">مشاهده</button>
                        </div>
                        <div class="col-3">
                            <p>${data.operator.name}</p>
                        </div>
                        <div class="col-2">
                            <button class="btn-delete">
                                حذف    
                            </button>
                        <div>
                    </div>
                `
            }

            function getElementOptionSelectDistrict(data){
                return `
                    <option value="${data.id}">${data.name}</option>
                `
            }

            
            function getElementOptionSelectOperator(data){
                return `
                    <option value="${data.id}">${data.name}</option>
                `
            }



        </script>

    </body>
</html>